{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "microsoft-sso",
  "type": "registry:file",
  "title": "Microsoft SSO",
  "description": "A Microsoft SSO recipe",
  "dependencies": [
    "@nestjs/common",
    "@nestjs/passport",
    "@nestjs/axios",
    "passport-oauth2"
  ],
  "registryDependencies": [],
  "files": [
    {
      "path": "registry/recipes/server/microsoft-sso/microsoft.strategy.ts",
      "content": "import { HttpService } from '@nestjs/axios';\nimport { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { logger } from '@repo/logger';\nimport { ServerEnv } from '@repo/shared';\nimport { Strategy } from 'passport-oauth2';\n\nimport type { MicrosoftProfile } from '@/modules/auth/models/microsoft.dto';\nimport { IUser } from '@/modules/common/decorators/user.decorator';\nimport { PrismaService } from '@/modules/prisma/prisma.service';\nimport { encrypt } from '@/utils/encrypt';\n\n@Injectable()\nexport class MicrosoftStrategy extends PassportStrategy(Strategy, 'microsoft') {\n  constructor(\n    private readonly configService: ConfigService,\n    private readonly prismaService: PrismaService,\n    private readonly httpService: HttpService\n  ) {\n    super({\n      tokenURL: `${configService.getOrThrow(ServerEnv.MICROSOFT_AUTHORITY_URL)}/${configService.getOrThrow(ServerEnv.MICROSOFT_TENANT_ID)}/oauth2/v2.0/token`,\n      authorizationURL: `${configService.getOrThrow(ServerEnv.MICROSOFT_AUTHORITY_URL)}/${configService.getOrThrow(ServerEnv.MICROSOFT_TENANT_ID)}/oauth2/v2.0/authorize?prompt=select_account`,\n      clientID: configService.getOrThrow(ServerEnv.MICROSOFT_CLIENT_ID),\n      clientSecret: configService.getOrThrow(ServerEnv.MICROSOFT_CLIENT_SECRET),\n      callbackURL: `${configService.getOrThrow(ServerEnv.BACKEND_URL)}/api/auth/microsoft/callback`,\n      scope: ['User.Read', 'openid', 'profile'],\n    });\n  }\n  async validate(accessToken: string): Promise<IUser> {\n    try {\n      const response = await this.httpService.axiosRef\n        .get<MicrosoftProfile>(\n          `${this.configService.getOrThrow(ServerEnv.MICROSOFT_GRAPH_URL)}/v1.0/me`,\n          {\n            headers: {\n              Authorization: `Bearer ${accessToken}`,\n            },\n          }\n        )\n        .catch(() => {\n          throw new Error('Error contacting Microsoft Graph API');\n        });\n\n      const userProfile = response.data;\n\n      const email = (\n        userProfile.mail ?? userProfile.userPrincipalName\n      ).toLowerCase();\n\n      if (!email) {\n        throw new Error('No email found in Microsoft profile');\n      }\n\n      const firstName = userProfile.givenName || 'Unknown';\n      const lastName = userProfile.surname || 'User';\n      // TODO: later when token is used, we should do checks on when to refresh the token, expiration date etc.\n      const user = await this.prismaService.user\n        .upsert({\n          where: { email },\n          create: {\n            email,\n            firstName,\n            lastName,\n            microsoftOAuth: {\n              create: {\n                accessToken: encrypt(accessToken),\n              },\n            },\n          },\n          update: {\n            firstName,\n            lastName,\n            microsoftOAuth: {\n              upsert: {\n                create: {\n                  accessToken: encrypt(accessToken),\n                },\n                update: {\n                  accessToken: encrypt(accessToken),\n                },\n              },\n            },\n          },\n          include: {\n            microsoftOAuth: true,\n          },\n        })\n        .catch(() => {\n          throw new Error(`Could not find user with email: ${email}`);\n        });\n\n      return {\n        id: user.id,\n        email: user.email,\n        role: user.role,\n      };\n    } catch (error) {\n      logger.error('Error in Microsoft strategy', { error });\n      throw new UnauthorizedException(\n        `Error in Microsoft strategy: ${error instanceof Error ? error.message : 'Unknown error'}`\n      );\n    }\n  }\n}\n",
      "type": "registry:file",
      "target": "src/modules/auth/microsoft.strategy.ts"
    },
    {
      "path": "registry/recipes/server/microsoft-sso/microsoft.guard.ts",
      "content": "import { Injectable } from '@nestjs/common';\nimport { AuthGuard } from '@nestjs/passport';\n\n@Injectable()\nexport class MicrosoftGuard extends AuthGuard('microsoft') {}\n",
      "type": "registry:file",
      "target": "src/modules/auth/microsoft.guard.ts"
    },
    {
      "path": "registry/recipes/server/microsoft-sso/microsoft.dto.ts",
      "content": "export interface MicrosoftProfile {\n  businessPhones: Array<string>;\n  displayName: string;\n  givenName: string;\n  jobTitle: string | null;\n  mail?: string;\n  mobilePhone: string;\n  officeLocation: string;\n  preferredLanguage: string;\n  surname: string;\n  userPrincipalName: string;\n  id: string;\n}\n",
      "type": "registry:file",
      "target": "src/modules/auth/models/microsoft.dto.ts"
    },
    {
      "path": "registry/recipes/server/microsoft-sso/MICROSOFT-SSO.MD",
      "content": "# Microsoft SSO\n\n## Installation\n\nThe recipe includes 3 files:\n\n- **microsoft.strategy.ts:** when the microsoft.guard is hit when accessing an endpoint, the microsoft.strategy is used to authorize & authenticate a user.\n- **microsoft.guard.ts:** hit by an endpoint. If unauthorized, this will trigger the microsoft.strategy and redirects a user to the microsoft login page.\n- **microsoft.dto.ts:** TS types\n\n## Usage\n\nWhen all files are pulled from the registry, you still need to 'apply' them. This happens in your `auth.controller`, if you're using the faktion-kickstarter.\n\nSnippet of changes you need to apply:\n\n### auth.controller\n\n```ts\nexport class AuthController {\n...\n  @Get('microsoft')\n  @UseGuards(MicrosoftGuard)\n  @ApiOperation({\n    operationId: 'microsoftAuth',\n    summary: 'Initiate Microsoft OAuth authentication',\n  })\n  async microsoftAuth() {\n    // The guard will handle the redirect to Microsoft\n  }\n\n  @Get('microsoft/callback')\n  @UseGuards(MicrosoftGuard)\n  @ApiOperation({\n    operationId: 'microsoftCallback',\n    summary: 'Handle Microsoft OAuth callback',\n  })\n  async microsoftCallback(@Res() res: Response, @User() user: IUser) {\n    this.authService.redirect(user, res);\n  }\n...\n}\n```\n\n### auth.service\n\n```ts\nexport class AuthService {\n...\n    redirect(user: IUser, response: express.Response) {\n        const result = this.login(user);\n\n        const frontendUrl = this.configService.getOrThrow(ServerEnv.FRONTEND_URL);\n        const redirectUrl = `${frontendUrl}/auth/login?token=${result.access_token}`;\n\n        response.redirect(redirectUrl);\n    }\n...\n}\n\n```\n\n### Environment variables\n\n- Expand the `.env.example`:\n\n```\n# Microsoft entra\nMICROSOFT_AUTHORITY_URL=https://login.microsoftonline.com\nMICROSOFT_GRAPH_URL=https://graph.microsoft.com\nMICROSOFT_CLIENT_ID=*** # received when registering the application on Entra\nMICROSOFT_CLIENT_SECRET=*** # received when registering the application on Entra\nMICROSOFT_TENANT_ID=*** # received when registering the application on Entra\n```\n\n- Expand the `ServerEnv` enum in the shared packages with the variables above\n",
      "type": "registry:file",
      "target": "docs/MICROSOFT-SSO.MD"
    }
  ],
  "categories": [
    "recipes"
  ]
}